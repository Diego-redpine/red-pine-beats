<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Portal - Red Pine</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .customer-benefits {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--gray-medium);
    }
    .benefit-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 14px;
      color: var(--gray-dark);
    }
    .benefit-icon {
      width: 32px;
      height: 32px;
      background: var(--gray-light);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--red);
    }
    .magic-link-sent {
      text-align: center;
      padding: 32px 0;
    }
    .magic-link-sent .icon-circle {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }
    .magic-link-sent .icon-circle i {
      color: white;
      width: 40px;
      height: 40px;
    }
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }
    .step {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gray-medium);
    }
    .step.active {
      background: var(--red);
      width: 24px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-card" style="max-width: 420px;">
      <div class="auth-logo">
        <img src="assets/images/red_pine_logo.png" alt="Red Pine" style="width: 48px; height: 48px;">
        <span style="font-size: 24px; font-weight: 700; color: var(--black); margin-top: 8px;">Customer Portal</span>
      </div>

      <!-- Step 1: Email Entry -->
      <div id="emailStep">
        <h1 class="auth-title" style="font-size: 20px; margin-bottom: 8px;">Access Your Purchases</h1>
        <p style="color: var(--gray-dark); font-size: 14px; margin-bottom: 24px; text-align: center;">
          Enter your email to receive a secure login link
        </p>

        <div id="errorMessage"></div>

        <form id="magicLinkForm">
          <div class="form-group">
            <label class="form-label">Email Address</label>
            <input type="email" class="form-input" id="customerEmail" required placeholder="your@email.com" autocomplete="email">
          </div>

          <button type="submit" class="btn btn-primary" style="width: 100%;" id="submitBtn">
            <i data-lucide="mail" style="width:18px;height:18px;margin-right:8px;"></i>
            Send Login Link
          </button>
        </form>

        <div class="customer-benefits">
          <div class="benefit-item">
            <div class="benefit-icon">
              <i data-lucide="download" style="width:16px;height:16px;"></i>
            </div>
            <span>Re-download your purchased beats anytime</span>
          </div>
          <div class="benefit-item">
            <div class="benefit-icon">
              <i data-lucide="history" style="width:16px;height:16px;"></i>
            </div>
            <span>View your complete purchase history</span>
          </div>
          <div class="benefit-item">
            <div class="benefit-icon">
              <i data-lucide="file-text" style="width:16px;height:16px;"></i>
            </div>
            <span>Access your license agreements</span>
          </div>
        </div>
      </div>

      <!-- Step 2: Link Sent Confirmation -->
      <div id="linkSentStep" style="display: none;">
        <div class="magic-link-sent">
          <div class="icon-circle">
            <i data-lucide="mail-check"></i>
          </div>
          <h2 style="margin-bottom: 12px; font-size: 20px;">Check Your Email</h2>
          <p style="color: var(--gray-dark); font-size: 14px; line-height: 1.6; margin-bottom: 24px;">
            We sent a login link to<br>
            <strong id="sentToEmail" style="color: var(--black);"></strong>
          </p>
          <p style="color: var(--gray-dark); font-size: 13px; margin-bottom: 24px;">
            Click the link in the email to access your purchases.<br>
            The link expires in 15 minutes.
          </p>
          <button class="btn btn-secondary" style="width: 100%;" onclick="showEmailStep()">
            <i data-lucide="arrow-left" style="width:16px;height:16px;margin-right:8px;"></i>
            Use Different Email
          </button>
        </div>
      </div>

      <!-- No Purchases Found -->
      <div id="noPurchasesStep" style="display: none;">
        <div class="magic-link-sent">
          <div class="icon-circle" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);">
            <i data-lucide="inbox"></i>
          </div>
          <h2 style="margin-bottom: 12px; font-size: 20px;">No Purchases Found</h2>
          <p style="color: var(--gray-dark); font-size: 14px; line-height: 1.6; margin-bottom: 24px;">
            We couldn't find any purchases for<br>
            <strong id="noResultsEmail" style="color: var(--black);"></strong>
          </p>
          <p style="color: var(--gray-dark); font-size: 13px; margin-bottom: 24px;">
            Make sure you're using the same email address you used when making your purchase.
          </p>
          <button class="btn btn-secondary" style="width: 100%;" onclick="showEmailStep()">
            <i data-lucide="arrow-left" style="width:16px;height:16px;margin-right:8px;"></i>
            Try Different Email
          </button>
        </div>
      </div>

      <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--gray-medium); text-align: center; font-size: 12px; color: var(--gray-dark);">
        <span>Are you a producer?</span>
        <a href="login.html" style="color: var(--red); text-decoration: none; margin-left: 4px;">Producer Login</a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/config.js"></script>
  <script>
    // Initialize icons
    lucide.createIcons();

    const magicLinkForm = document.getElementById('magicLinkForm');
    const errorMessage = document.getElementById('errorMessage');
    const submitBtn = document.getElementById('submitBtn');

    // Check if returning from magic link
    checkMagicLinkReturn();

    async function checkMagicLinkReturn() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const email = params.get('email');

      if (token && email) {
        // Verify token and redirect to portal
        try {
          const response = await fetch('/.netlify/functions/verify-customer-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, email })
          });

          const result = await response.json();

          if (response.ok && result.valid) {
            // Store session and redirect
            sessionStorage.setItem('customerEmail', email);
            sessionStorage.setItem('customerToken', token);
            sessionStorage.setItem('customerSession', Date.now().toString());
            window.location.href = 'customer-portal.html';
          } else {
            errorMessage.innerHTML = '<div class="alert alert-error">This login link has expired or is invalid. Please request a new one.</div>';
          }
        } catch (error) {
          console.error('Token verification error:', error);
          errorMessage.innerHTML = '<div class="alert alert-error">Unable to verify login link. Please try again.</div>';
        }
      }
    }

    magicLinkForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('customerEmail').value.trim().toLowerCase();

      if (!email) {
        errorMessage.innerHTML = '<div class="alert alert-error">Please enter your email address.</div>';
        return;
      }

      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader" style="width:18px;height:18px;margin-right:8px;animation:spin 1s linear infinite;"></i> Sending...';
      lucide.createIcons();
      errorMessage.innerHTML = '';

      try {
        // First check if customer has any purchases
        const checkResponse = await fetch('/.netlify/functions/check-customer-purchases', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const checkResult = await checkResponse.json();

        if (!checkResponse.ok || !checkResult.hasPurchases) {
          // No purchases found
          document.getElementById('noResultsEmail').textContent = email;
          document.getElementById('emailStep').style.display = 'none';
          document.getElementById('noPurchasesStep').style.display = 'block';
          lucide.createIcons();
          return;
        }

        // Has purchases - send magic link
        const response = await fetch('/.netlify/functions/send-customer-magic-link', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Show success state
          document.getElementById('sentToEmail').textContent = email;
          document.getElementById('emailStep').style.display = 'none';
          document.getElementById('linkSentStep').style.display = 'block';
          lucide.createIcons();
        } else {
          throw new Error(result.error || 'Failed to send login link');
        }
      } catch (error) {
        console.error('Magic link error:', error);
        errorMessage.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-lucide="mail" style="width:18px;height:18px;margin-right:8px;"></i> Send Login Link';
        lucide.createIcons();
      }
    });

    function showEmailStep() {
      document.getElementById('emailStep').style.display = 'block';
      document.getElementById('linkSentStep').style.display = 'none';
      document.getElementById('noPurchasesStep').style.display = 'none';
      document.getElementById('customerEmail').value = '';
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i data-lucide="mail" style="width:18px;height:18px;margin-right:8px;"></i> Send Login Link';
      lucide.createIcons();
    }

    // Add spinner animation
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
    document.head.appendChild(style);
  </script>
</body>
</html>
