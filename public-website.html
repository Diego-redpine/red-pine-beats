<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading... - Red Pine</title>
  <meta name="theme-color" content="#CE0707">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      color: #1f2937;
    }

    /* Loading state */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #dc2626;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 16px;
      color: #6b7280;
      font-size: 14px;
    }

    /* Error state */
    .error-container {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px;
      text-align: center;
    }

    .error-icon {
      width: 64px;
      height: 64px;
      color: #dc2626;
      margin-bottom: 16px;
    }

    .error-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .error-message {
      color: #6b7280;
      font-size: 16px;
      max-width: 400px;
    }

    /* Rendered site container */
    #siteContent {
      display: none;
      min-height: 100vh;
    }

    /* Block styles for rendering */
    .site-block {
      width: 100%;
    }

    /* Powered by footer */
    .powered-by {
      text-align: center;
      padding: 24px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      font-size: 12px;
      color: #9ca3af;
    }

    .powered-by a {
      color: #dc2626;
      text-decoration: none;
    }

    .powered-by a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Loading state -->
  <div class="loading-container" id="loadingState">
    <div class="loading-spinner"></div>
    <p class="loading-text">Loading site...</p>
  </div>

  <!-- Error state -->
  <div class="error-container" id="errorState">
    <i data-lucide="alert-circle" class="error-icon"></i>
    <h1 class="error-title" id="errorTitle">Site Not Found</h1>
    <p class="error-message" id="errorMessage">This site doesn't exist or hasn't been published yet.</p>
  </div>

  <!-- Rendered site content -->
  <div id="siteContent">
    <main id="siteBlocks"></main>
    <footer class="powered-by">
      Powered by <a href="/">Red Pine</a>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/config.js"></script>
  <script>
    // Initialize Lucide
    lucide.createIcons();

    // Get username from URL
    function getUsernameFromUrl() {
      const path = window.location.pathname;
      // Support /site/username or /username formats
      const match = path.match(/^\/(site\/)?([^\/]+)\/?$/);
      return match ? match[2] : null;
    }

    // Show error state
    function showError(title, message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('siteContent').style.display = 'none';
      document.getElementById('errorState').style.display = 'flex';
      document.getElementById('errorTitle').textContent = title;
      document.getElementById('errorMessage').textContent = message;
      lucide.createIcons();
    }

    // Render a block
    function renderBlock(block) {
      const { type, props } = block;

      switch (type) {
        case 'heading':
          const level = props.level || 'h1';
          return `<${level} style="text-align: ${props.align || 'left'}; font-size: ${props.fontSize || 32}px; font-weight: ${props.fontWeight || 600}; color: ${props.color || '#1f2937'}; margin: 0; padding: 16px 24px; line-height: ${props.lineHeight || 1.2};">${props.text || ''}</${level}>`;

        case 'text':
          return `<p style="text-align: ${props.align || 'left'}; font-size: ${props.fontSize || 16}px; color: ${props.color || '#374151'}; line-height: ${props.lineHeight || 1.6}; margin: 0; padding: 16px 24px;">${props.text || ''}</p>`;

        case 'button':
          const btnPadding = props.padding === 'large' ? '14px 28px' : props.padding === 'small' ? '8px 16px' : '10px 20px';
          const btnTarget = props.target === '_blank' ? ' target="_blank" rel="noopener"' : '';
          return `<div style="text-align: ${props.align || 'left'}; padding: 16px 24px;"><a href="${props.url || '#'}"${btnTarget} style="display: inline-block; background: ${props.backgroundColor || '#dc2626'}; color: ${props.textColor || '#fff'}; padding: ${btnPadding}; border-radius: ${props.borderRadius || 6}px; text-decoration: none; font-weight: ${props.fontWeight || 600};">${props.text || 'Button'}</a></div>`;

        case 'spacer':
          return `<div style="height: ${props.height || 40}px;"></div>`;

        case 'divider':
          return `<div style="padding: ${props.margin || 24}px 24px; text-align: center;"><hr style="border: none; border-top: ${props.thickness || 1}px ${props.style || 'solid'} ${props.color || '#e5e7eb'}; margin: 0 auto; width: ${props.width || 100}%;"></div>`;

        case 'image':
          if (!props.src) return '';
          return `<div style="text-align: ${props.align || 'center'}; padding: 16px 24px;"><img src="${props.src}" alt="${props.alt || ''}" style="max-width: ${props.maxWidth || 100}%; border-radius: ${props.borderRadius || 0}px; object-fit: ${props.objectFit || 'cover'};"></div>`;

        case 'video':
          if (!props.url) return '';
          // Parse YouTube/Vimeo URL
          let embedUrl = '';
          if (props.url.includes('youtube.com') || props.url.includes('youtu.be')) {
            const videoId = props.url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)?.[1];
            if (videoId) {
              embedUrl = `https://www.youtube.com/embed/${videoId}`;
              if (props.autoplay) embedUrl += '?autoplay=1';
              if (props.muted) embedUrl += (embedUrl.includes('?') ? '&' : '?') + 'mute=1';
              if (props.loop) embedUrl += (embedUrl.includes('?') ? '&' : '?') + 'loop=1';
            }
          } else if (props.url.includes('vimeo.com')) {
            const videoId = props.url.match(/vimeo\.com\/(\d+)/)?.[1];
            if (videoId) {
              embedUrl = `https://player.vimeo.com/video/${videoId}`;
            }
          }
          if (!embedUrl) return '';
          const aspectRatio = props.aspectRatio === '4:3' ? '4/3' : props.aspectRatio === '1:1' ? '1/1' : '16/9';
          return `<div style="padding: 16px 24px;"><div style="aspect-ratio: ${aspectRatio}; position: relative;"><iframe src="${embedUrl}" style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0; border-radius: 8px;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div></div>`;

        case 'link':
          const linkTarget = props.target === '_blank' ? ' target="_blank" rel="noopener"' : '';
          return `<div style="text-align: ${props.align || 'left'}; padding: 16px 24px;"><a href="${props.url || '#'}"${linkTarget} style="color: ${props.color || '#dc2626'}; font-size: ${props.fontSize || 16}px; text-decoration: ${props.underline ? 'underline' : 'none'};">${props.text || ''}</a></div>`;

        case 'social-icons':
          const iconItems = (props.icons || []).map(icon => {
            if (!icon.url) return '';
            return `<a href="${icon.url}" target="_blank" rel="noopener" style="color: ${props.color || '#1f2937'};"><i data-lucide="${icon.platform}" style="width: ${props.size || 24}px; height: ${props.size || 24}px;"></i></a>`;
          }).join('');
          if (!iconItems) return '';
          return `<div style="text-align: ${props.align || 'center'}; padding: 16px 24px; display: flex; gap: ${props.spacing || 16}px; justify-content: ${props.align === 'left' ? 'flex-start' : props.align === 'right' ? 'flex-end' : 'center'};">${iconItems}</div>`;

        default:
          return '';
      }
    }

    // Render site
    function renderSite(design) {
      if (!design || !design.blocks || design.blocks.length === 0) {
        showError('Empty Site', 'This site has no content yet.');
        return;
      }

      const blocksHtml = design.blocks.map(block => renderBlock(block)).join('');
      document.getElementById('siteBlocks').innerHTML = blocksHtml;
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('siteContent').style.display = 'block';
      lucide.createIcons();
    }

    // Load and render site
    async function loadSite() {
      const username = getUsernameFromUrl();

      if (!username) {
        showError('Site Not Found', 'Invalid URL. Please check the address.');
        return;
      }

      try {
        // Get producer by subdomain or ID
        const { data: producer, error: producerError } = await supabaseClient
          .from('producers')
          .select('id, name, subdomain')
          .or(`subdomain.eq.${username},id.eq.${username}`)
          .single();

        if (producerError || !producer) {
          showError('Site Not Found', "This site doesn't exist or hasn't been created yet.");
          return;
        }

        // Get site customization
        const { data: site, error: siteError } = await supabaseClient
          .from('site_customizations')
          .select('website_json, website_published')
          .eq('producer_id', producer.id)
          .single();

        if (siteError || !site) {
          showError('Site Not Found', "This site hasn't been set up yet.");
          return;
        }

        if (!site.website_published) {
          showError('Site Unpublished', 'This site is not currently published.');
          return;
        }

        // Parse and render
        let design = null;
        try {
          design = JSON.parse(site.website_json);
        } catch (e) {
          showError('Error', 'Failed to load site content.');
          return;
        }

        // Update page title
        document.title = `${producer.name || username} - Red Pine`;

        renderSite(design);

      } catch (err) {
        console.error('Load site error:', err);
        showError('Error', 'An unexpected error occurred.');
      }
    }

    // Initialize
    loadSite();
  </script>
</body>
</html>
